// airbrake-notifier.js
// @weblinc, @jsantell, (c) 2012
// leveraging notifier.js of https://www.github.com/errbit/errbit
// printStackTrace() license below

(function(){function c(a){var b=a&&a.e?a.e:null;a=a?!!a.guess:!0;var d=new c.implementation;return b=d.run(b),a?d.guessFunctions(b):b}var a="2.0",b="/notifier_api/v2/notices.xml?data=";window.AirbrakeInit=function(a){Airbrake.setKey(a.key||""),Airbrake.setHost(a.host||""),Airbrake.setEnvironment(a.env||""),Airbrake.setErrorDefaults(a.defaults||"")},window.Airbrake={VERSION:a,NOTICE_XML:'<?xml version="1.0" encoding="UTF-8"?>    <notice version="'+a+'">      <api-key></api-key>      <notifier>        <name>errbit_notifier_js</name>        <version>'+parseFloat(a)+"</version>        <url>https://github.com/errbit/errbit</url>      </notifier>      <error>        <class>EXCEPTION_CLASS</class>        <message>EXCEPTION_MESSAGE</message>        <backtrace>BACKTRACE_LINES</backtrace>      </error>      <request>        <url>REQUEST_URL</url>        <component>REQUEST_COMPONENT</component>        <action>REQUEST_ACTION</action>      </request>      <server-environment>        <project-root>PROJECT_ROOT</project-root>        <environment-name>production</environment-name>      </server-environment>    </notice>",ROOT:window.location.protocol+"//"+window.location.host,BACKTRACE_MATCHER:/^(.*)\@(.*)\:(\d+)$/,backtrace_filters:[/\/notifier\.js/],notify:function(a){var c=escape(Airbrake.generateXML(a)),d=Airbrake.host,e="//"+d+b+c,f=document.createElement("iframe");f.style.width="1px",f.style.height="1px",f.style.display="none",f.src=e,document.getElementsByTagName("head")[0].appendChild(f)},setEnvironment:function(a){var b=/<environment-name>.*<\/environment-name>/;Airbrake.NOTICE_XML=Airbrake.NOTICE_XML.replace(b,"<environment-name>"+a+"</environment-name>")},setHost:function(a){Airbrake.host=a},setKey:function(a){var b=/<api-key>.*<\/api-key>/;Airbrake.NOTICE_XML=Airbrake.NOTICE_XML.replace(b,"<api-key>"+a+"</api-key>")},setErrorDefaults:function(a){Airbrake.errorDefaults=a},generateXML:function(a){var b=Airbrake.mergeDefault(Airbrake.errorDefaults,a),c=Airbrake.NOTICE_XML,d=Airbrake.escapeText(b.url||""),e=Airbrake.escapeText(b.component||""),f=Airbrake.escapeText(b.action||""),g=Airbrake.escapeText(b.type||"Error"),h=Airbrake.escapeText(b.message||"Unknown error."),i=Airbrake.generateBacktrace(b);if(Airbrake.trim(d)==""&&Airbrake.trim(e)=="")c=c.replace(/<request>.*<\/request>/,"");else{var j="",k=b["cgi-data"]||{};k.HTTP_USER_AGENT=navigator.userAgent,j+="<cgi-data>",j+=Airbrake.generateVariables(k),j+="</cgi-data>";var l=["params","session"];for(var m=0;m<2;m++){var g=l[m];b[g]&&(j+="<"+g+">",j+=Airbrake.generateVariables(b[g]),j+="</"+g+">")}c=c.replace("</request>",j+"</request>").replace("REQUEST_URL",d).replace("REQUEST_ACTION",f).replace("REQUEST_COMPONENT",e)}return c.replace("PROJECT_ROOT",Airbrake.ROOT).replace("EXCEPTION_CLASS",g).replace("EXCEPTION_MESSAGE",h).replace("BACKTRACE_LINES",i.join(""))},generateBacktrace:function(a){a=a||{};if(typeof a.stack!="string")try{(0)()}catch(b){a.stack=b.stack}var c=[],d=Airbrake.getStackTrace(a);for(var e=0,f=d.length;e<f;e++){var g=d[e],h=g.match(Airbrake.BACKTRACE_MATCHER);if(h&&Airbrake.validBacktraceLine(g)){var i=h[2].replace(Airbrake.ROOT,"[PROJECT_ROOT]");e==0&&h[2].match(document.location.href)&&c.push('<line method="" file="internal: " number=""/>'),c.push('<line method="'+Airbrake.escapeText(h[1])+'" file="'+Airbrake.escapeText(i)+'" number="'+h[3]+'" />')}}return c},getStackTrace:function(a){var b=c({e:a,guess:!1});for(var d=0,e=b.length;d<e;d++){if(b[d].match(/\:\d+$/))continue;b[d].indexOf("@")==-1&&(b[d]+="@unsupported.js"),b[d]+=":0"}return b},validBacktraceLine:function(a){for(var b=0;b<Airbrake.backtrace_filters.length;b++)if(a.match(Airbrake.backtrace_filters[b]))return!1;return!0},generateVariables:function(a){var b,c="";for(b in a)c+='<var key="'+Airbrake.escapeText(b)+'">'+Airbrake.escapeText(a[b])+"</var>";return c},escapeText:function(a){return a.replace(/&/g,"&#38;").replace(/</g,"&#60;").replace(/>/g,"&#62;").replace(/'/g,"&#39;").replace(/"/g,"&#34;")},trim:function(a){return a.toString().replace(/^\s+/,"").replace(/\s+$/,"")},mergeDefault:function(a,b){var c={},d;for(d in b)c[d]=b[d];for(d in a)c.hasOwnProperty(d)||(c[d]=a[d]);return c}},c.implementation=function(){},c.implementation.prototype={run:function(a){var b=this._mode||this.mode();if(b==="other")return this.other(arguments.callee);var c;if(!(c=a))a:{try{(0)()}catch(d){c=d;break a}c=void 0}return a=c,this[b](a)},mode:function(){try{(0)()}catch(a){if(a.arguments)return this._mode="chrome";if(a.stack)return this._mode="firefox";if(window.opera&&!("stacktrace"in a))return this._mode="opera"}return this._mode="other"},chrome:function(a){return a.stack.replace(/^.*?\n/,"").replace(/^.*?\n/,"").replace(/^.*?\n/,"").replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n")},firefox:function(a){return a.stack.replace(/^.*?\n/,"").replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n")},opera:function(a){a=a.message.split("\n");var b=/Line\s+(\d+).*?script\s+(http\S+)(?:.*?in\s+function\s+(\S+))?/i,c,d,e;c=4,d=0;for(e=a.length;c<e;c+=2)b.test(a[c])&&(a[d++]=(RegExp.$3?RegExp.$3+"()@"+RegExp.$2+RegExp.$1:"{anonymous}()@"+RegExp.$2+":"+RegExp.$1)+" -- "+a[c+1].replace(/^\s+/,""));return a.splice(d,a.length-d),a},other:function(a){for(var b=/function\s*([\w\-$]+)?\s*\(/i,d=[],e=0,f,g;a&&d.length<10;){f=b.test(a.toString())?RegExp.$1||"{anonymous}":"{anonymous}",g=Array.prototype.slice.call(a.arguments),d[e++]=f+"("+c.implementation.prototype.stringifyArguments(g)+")";if(a===a.caller&&window.opera)break;a=a.caller}return d},stringifyArguments:function(a){for(var b=0;b<a.length;++b){var c=a[b];typeof c=="object"?a[b]="#object":typeof c=="function"?a[b]="#function":typeof c=="string"&&(a[b]='"'+c+'"')}return a.join(",")},sourceCache:{},ajax:function(a){var b=this.createXMLHTTPObject();if(b)return b.open("GET",a,!1),b.setRequestHeader("User-Agent","XMLHTTP/1.0"),b.send(""),b.responseText},createXMLHTTPObject:function(){for(var a,b=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],c=0;c<b.length;c++)try{return a=b[c](),this.createXMLHTTPObject=b[c],a}catch(d){}},getSource:function(a){return a in this.sourceCache||(this.sourceCache[a]=this.ajax(a).split("\n")),this.sourceCache[a]},guessFunctions:function(a){for(var b=0;b<a.length;++b){var c=a[b],d=/{anonymous}\(.*\)@(\w+:\/\/([-\w\.]+)+(:\d+)?[^:]+):(\d+):?(\d+)?/.exec(c);if(d){var e=d[1];d=d[4],e&&d&&(e=this.guessFunctionName(e,d),a[b]=c.replace("{anonymous}",e))}}return a},guessFunctionName:function(a,b){try{return this.guessFunctionNameFromLines(b,this.getSource(a))}catch(c){return"getSource failed with url: "+a+", exception: "+c.toString()}},guessFunctionNameFromLines:function(a,b){for(var c=/function ([^(]*)\(([^)]*)\)/,d=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*(function|eval|new Function)/,e="",f=0;f<10;++f){e=b[a-f]+e;if(e!==undefined){var g=d.exec(e);if(g&&g[1])return g[1];if((g=c.exec(e))&&g[1])return g[1]}}return"(?)"}},window.onerror=function(a,b,c){return setTimeout(function(){Airbrake.notify({message:a,stack:"()@"+b+":"+c})},100),!0}})()